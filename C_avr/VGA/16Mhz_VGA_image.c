#define F_CPU 16000000UL

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>

#define nop asm volatile("nop\n\t") // delay for 1 clock : 1 / 16Mhz = 0.0625us

#define VSYNC_PIN PB4 // v sunc output : OC1B
#define HSYNC_PIN PE3 // h sync output : OC3A

// configurations of image data pin
#define RED_PIN_0 PC0
#define RED_PIN_1 PC1
#define GREEN_PIN_0 PC2
#define GREEN_PIN_1 PC3
#define BLUE_PIN_0 PC4
#define BLUE_PIN_1 PC5

#define VERTICAL_BACK_PORCH_LINES 35

#define IMAGE_HEIGHT 64
#define IMAGE_WIDTH 48

#define TIMING_ADJUST_FACTOR1 2
#define TIMING_ADJUST_FACTOR2 7

uint8_t image_color[IMAGE_WIDTH][IMAGE_HEIGHT] = {
    {0x29, 0x14, 0x04, 0x28, 0x29, 0x3A, 0x29, 0x24, 0x24, 0x14, 0x14, 0x14, 0x29, 0x2A, 0x2F, 0x3F, 0x3F, 0x2A, 0x2A, 0x2A, 0x2E, 0x2F, 0x3F, 0x2E, 0x3B, 0x2E, 0x3A, 0x2A, 0x29, 0x29, 0x05, 0x04, 0x04, 0x04, 0x05, 0x09, 0x09, 0x05, 0x05, 0x05, 0x04, 0x05, 0x04, 0x00, 0x05, 0x1A, 0x2F, 0x2A, 0x2A, 0x09, 0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04},
    {0x19, 0x04, 0x15, 0x3A, 0x3E, 0x3B, 0x3E, 0x3A, 0x29, 0x19, 0x25, 0x29, 0x1A, 0x2A, 0x3F, 0x2E, 0x3F, 0x2F, 0x2E, 0x2A, 0x2F, 0x3A, 0x3F, 0x3F, 0x2E, 0x3F, 0x2E, 0x2A, 0x2A, 0x1A, 0x05, 0x05, 0x05, 0x04, 0x09, 0x1A, 0x09, 0x0A, 0x09, 0x09, 0x05, 0x05, 0x04, 0x05, 0x04, 0x09, 0x19, 0x09, 0x05, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x04, 0x08, 0x08, 0x04},
    {0x09, 0x14, 0x29, 0x3F, 0x3F, 0x3F, 0x3E, 0x2A, 0x29, 0x15, 0x29, 0x19, 0x2A, 0x2E, 0x3B, 0x3F, 0x3F, 0x2A, 0x3F, 0x2A, 0x2E, 0x3F, 0x2F, 0x3A, 0x3F, 0x2B, 0x3E, 0x2A, 0x2A, 0x29, 0x05, 0x15, 0x04, 0x05, 0x08, 0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x05, 0x05, 0x04, 0x00, 0x05, 0x04, 0x05, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x09, 0x09},
    {0x0A, 0x29, 0x3A, 0x3E, 0x3F, 0x2A, 0x3F, 0x3A, 0x2A, 0x19, 0x15, 0x1A, 0x2A, 0x2F, 0x2E, 0x3B, 0x2E, 0x3F, 0x2A, 0x3F, 0x2A, 0x2A, 0x3F, 0x2E, 0x3B, 0x2E, 0x3A, 0x2A, 0x2A, 0x19, 0x1A, 0x19, 0x06, 0x08, 0x05, 0x09, 0x09, 0x0A, 0x09, 0x0A, 0x09, 0x05, 0x05, 0x05, 0x04, 0x09, 0x04, 0x08, 0x04, 0x04, 0x04, 0x04, 0x08, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x04, 0x1E},
    {0x1A, 0x2A, 0x3A, 0x2F, 0x3A, 0x3F, 0x3A, 0x2A, 0x19, 0x09, 0x09, 0x19, 0x2A, 0x2A, 0x2E, 0x2B, 0x3E, 0x2A, 0x2A, 0x2A, 0x2E, 0x2A, 0x2A, 0x2E, 0x2A, 0x2A, 0x2A, 0x29, 0x29, 0x2A, 0x16, 0x1A, 0x1A, 0x19, 0x05, 0x09, 0x0A, 0x09, 0x0A, 0x0A, 0x09, 0x04, 0x05, 0x09, 0x05, 0x09, 0x04, 0x09, 0x08, 0x04, 0x04, 0x08, 0x08, 0x08, 0x09, 0x04, 0x04, 0x04, 0x05, 0x04, 0x04, 0x09, 0x19, 0x3E},
    {0x2A, 0x2A, 0x29, 0x3A, 0x3E, 0x2A, 0x39, 0x29, 0x05, 0x05, 0x05, 0x05, 0x1A, 0x2A, 0x2A, 0x2E, 0x2A, 0x1A, 0x19, 0x29, 0x2A, 0x29, 0x3A, 0x29, 0x3A, 0x29, 0x29, 0x29, 0x2A, 0x29, 0x2A, 0x2A, 0x2A, 0x1A, 0x0A, 0x0A, 0x1A, 0x1E, 0x1F, 0x09, 0x0A, 0x0A, 0x0A, 0x1A, 0x0A, 0x09, 0x09, 0x05, 0x09, 0x04, 0x04, 0x05, 0x08, 0x04, 0x08, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x08, 0x09, 0x2F},
    {0x1A, 0x19, 0x19, 0x14, 0x29, 0x24, 0x28, 0x14, 0x04, 0x09, 0x19, 0x19, 0x19, 0x29, 0x2A, 0x29, 0x29, 0x19, 0x29, 0x29, 0x3A, 0x3E, 0x2E, 0x3A, 0x2E, 0x2A, 0x29, 0x29, 0x29, 0x2A, 0x3F, 0x2A, 0x2B, 0x2A, 0x1A, 0x0A, 0x1F, 0x2A, 0x2F, 0x0E, 0x0A, 0x1E, 0x1A, 0x0A, 0x1A, 0x1A, 0x0A, 0x09, 0x19, 0x08, 0x08, 0x04, 0x08, 0x19, 0x19, 0x05, 0x04, 0x04, 0x01, 0x04, 0x04, 0x05, 0x09, 0x2A},
    {0x09, 0x09, 0x04, 0x04, 0x04, 0x14, 0x00, 0x04, 0x15, 0x28, 0x29, 0x29, 0x3A, 0x2A, 0x39, 0x2A, 0x29, 0x25, 0x3A, 0x2A, 0x3E, 0x3B, 0x3E, 0x3F, 0x3A, 0x3E, 0x2A, 0x29, 0x2A, 0x2E, 0x3B, 0x2E, 0x2F, 0x1A, 0x0A, 0x0E, 0x2F, 0x1F, 0x1A, 0x0E, 0x0A, 0x1A, 0x1A, 0x0A, 0x1A, 0x2B, 0x1A, 0x2A, 0x2A, 0x29, 0x29, 0x18, 0x15, 0x29, 0x3E, 0x2A, 0x19, 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x08},
    {0x09, 0x05, 0x04, 0x04, 0x04, 0x05, 0x04, 0x04, 0x28, 0x29, 0x3A, 0x2A, 0x3E, 0x3A, 0x3E, 0x3A, 0x3A, 0x3E, 0x2E, 0x3A, 0x3F, 0x3F, 0x3F, 0x3E, 0x3F, 0x3E, 0x3E, 0x2A, 0x3E, 0x2A, 0x2E, 0x2B, 0x2A, 0x2E, 0x0A, 0x0A, 0x1A, 0x2E, 0x1F, 0x1A, 0x09, 0x09, 0x0A, 0x0A, 0x1A, 0x1E, 0x2F, 0x2F, 0x2A, 0x2A, 0x2A, 0x29, 0x2E, 0x3A, 0x3E, 0x3E, 0x3A, 0x15, 0x04, 0x01, 0x04, 0x00, 0x04, 0x04},
    {0x04, 0x04, 0x09, 0x04, 0x04, 0x04, 0x04, 0x15, 0x29, 0x3A, 0x3F, 0x3F, 0x3F, 0x3F, 0x2A, 0x3F, 0x3E, 0x3B, 0x3F, 0x3F, 0x3F, 0x3E, 0x3F, 0x3F, 0x3F, 0x3B, 0x3E, 0x3A, 0x2E, 0x3A, 0x2F, 0x2A, 0x2A, 0x0A, 0x0A, 0x0A, 0x0E, 0x1A, 0x1E, 0x1A, 0x0E, 0x09, 0x04, 0x09, 0x0A, 0x2B, 0x3F, 0x3F, 0x3F, 0x3F, 0x2E, 0x29, 0x3A, 0x3F, 0x3F, 0x3E, 0x2A, 0x29, 0x04, 0x00, 0x04, 0x05, 0x04, 0x04},
    {0x04, 0x04, 0x18, 0x04, 0x04, 0x05, 0x04, 0x29, 0x3A, 0x3F, 0x3F, 0x3E, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3E, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3E, 0x2E, 0x3E, 0x2A, 0x2E, 0x3F, 0x2E, 0x2B, 0x1A, 0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x09, 0x05, 0x08, 0x05, 0x1A, 0x2E, 0x2F, 0x3F, 0x3F, 0x3F, 0x3F, 0x2A, 0x3E, 0x3E, 0x2F, 0x3F, 0x3E, 0x2A, 0x04, 0x01, 0x04, 0x00, 0x04, 0x04},
    {0x04, 0x04, 0x05, 0x09, 0x08, 0x04, 0x29, 0x3A, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3E, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x2B, 0x2A, 0x2B, 0x26, 0x2A, 0x2A, 0x2A, 0x1A, 0x2A, 0x16, 0x02, 0x02, 0x02, 0x12, 0x06, 0x0A, 0x09, 0x0A, 0x09, 0x09, 0x09, 0x09, 0x2F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x2E, 0x3A, 0x3F, 0x3E, 0x3B, 0x3E, 0x29, 0x04, 0x04, 0x04, 0x04, 0x04, 0x09},
    {0x14, 0x04, 0x04, 0x04, 0x04, 0x05, 0x29, 0x3F, 0x3E, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3B, 0x3F, 0x3F, 0x3F, 0x3F, 0x2B, 0x16, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x01, 0x02, 0x02, 0x02, 0x11, 0x06, 0x09, 0x09, 0x05, 0x09, 0x0A, 0x2E, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x2A, 0x2E, 0x3A, 0x3E, 0x2A, 0x29, 0x05, 0x04, 0x04, 0x04, 0x08, 0x09},
    {0x04, 0x04, 0x14, 0x08, 0x04, 0x14, 0x29, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3A, 0x3E, 0x3F, 0x3E, 0x3F, 0x2B, 0x26, 0x07, 0x2A, 0x2A, 0x16, 0x07, 0x06, 0x03, 0x02, 0x02, 0x12, 0x02, 0x02, 0x02, 0x01, 0x12, 0x02, 0x02, 0x01, 0x02, 0x02, 0x02, 0x12, 0x09, 0x08, 0x05, 0x09, 0x1A, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x2F, 0x2A, 0x2E, 0x2F, 0x2A, 0x09, 0x09, 0x08, 0x09, 0x08, 0x09, 0x0A},
    {0x14, 0x04, 0x18, 0x14, 0x14, 0x04, 0x39, 0x3A, 0x3F, 0x3E, 0x3F, 0x3F, 0x3E, 0x3F, 0x3E, 0x3B, 0x3E, 0x3F, 0x12, 0x03, 0x16, 0x26, 0x15, 0x1A, 0x2A, 0x06, 0x12, 0x07, 0x02, 0x02, 0x02, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x12, 0x01, 0x02, 0x01, 0x02, 0x02, 0x06, 0x04, 0x09, 0x1A, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x2F, 0x0A, 0x0E, 0x1A, 0x0A, 0x09, 0x09, 0x09, 0x09, 0x05, 0x08, 0x0A},
    {0x04, 0x14, 0x28, 0x29, 0x14, 0x14, 0x15, 0x3E, 0x3A, 0x3F, 0x3E, 0x3B, 0x3E, 0x3A, 0x3A, 0x3E, 0x2A, 0x17, 0x02, 0x02, 0x16, 0x1A, 0x2A, 0x2A, 0x2B, 0x1A, 0x17, 0x02, 0x03, 0x02, 0x02, 0x02, 0x01, 0x01, 0x01, 0x02, 0x01, 0x02, 0x05, 0x05, 0x02, 0x02, 0x12, 0x17, 0x02, 0x05, 0x09, 0x1A, 0x3F, 0x3F, 0x3F, 0x3F, 0x2F, 0x0A, 0x0E, 0x0A, 0x0E, 0x0A, 0x09, 0x0A, 0x09, 0x09, 0x09, 0x09},
    {0x04, 0x25, 0x29, 0x28, 0x25, 0x04, 0x14, 0x29, 0x3A, 0x3E, 0x3F, 0x3A, 0x3F, 0x3E, 0x29, 0x39, 0x26, 0x02, 0x02, 0x11, 0x01, 0x12, 0x1A, 0x2B, 0x2A, 0x1A, 0x2A, 0x17, 0x02, 0x02, 0x02, 0x11, 0x02, 0x01, 0x01, 0x12, 0x01, 0x02, 0x15, 0x06, 0x05, 0x06, 0x06, 0x06, 0x13, 0x06, 0x05, 0x0A, 0x2E, 0x2F, 0x2F, 0x2B, 0x0E, 0x09, 0x0E, 0x0E, 0x1A, 0x2E, 0x19, 0x09, 0x09, 0x09, 0x04, 0x09},
    {0x24, 0x28, 0x29, 0x39, 0x28, 0x28, 0x29, 0x39, 0x39, 0x3A, 0x3E, 0x3E, 0x3A, 0x3A, 0x29, 0x28, 0x03, 0x02, 0x11, 0x06, 0x16, 0x15, 0x16, 0x16, 0x1A, 0x26, 0x2B, 0x1A, 0x12, 0x02, 0x02, 0x01, 0x01, 0x01, 0x00, 0x01, 0x15, 0x10, 0x14, 0x14, 0x14, 0x05, 0x0A, 0x06, 0x06, 0x03, 0x06, 0x09, 0x09, 0x0A, 0x1A, 0x09, 0x0A, 0x0A, 0x0A, 0x1E, 0x3E, 0x3A, 0x29, 0x09, 0x04, 0x09, 0x04, 0x04},
    {0x28, 0x29, 0x39, 0x29, 0x24, 0x3A, 0x3E, 0x3E, 0x3A, 0x29, 0x3A, 0x2A, 0x3E, 0x29, 0x19, 0x09, 0x02, 0x02, 0x02, 0x2A, 0x1A, 0x2A, 0x15, 0x15, 0x10, 0x05, 0x15, 0x16, 0x06, 0x02, 0x02, 0x02, 0x01, 0x01, 0x00, 0x00, 0x01, 0x14, 0x20, 0x14, 0x14, 0x14, 0x15, 0x0A, 0x06, 0x0A, 0x03, 0x06, 0x05, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x2A, 0x3E, 0x3E, 0x3A, 0x18, 0x04, 0x04, 0x04, 0x04},
    {0x3A, 0x3A, 0x3A, 0x39, 0x3E, 0x3E, 0x3B, 0x3E, 0x3E, 0x3A, 0x29, 0x3E, 0x29, 0x2A, 0x19, 0x09, 0x12, 0x02, 0x2A, 0x2B, 0x2B, 0x1A, 0x2A, 0x15, 0x05, 0x14, 0x05, 0x15, 0x02, 0x02, 0x01, 0x01, 0x02, 0x01, 0x00, 0x00, 0x00, 0x11, 0x14, 0x24, 0x20, 0x14, 0x14, 0x05, 0x05, 0x0A, 0x1A, 0x07, 0x0A, 0x09, 0x09, 0x09, 0x09, 0x09, 0x19, 0x3E, 0x3F, 0x3E, 0x3A, 0x28, 0x01, 0x04, 0x04, 0x04},
    {0x3F, 0x3E, 0x3F, 0x3E, 0x3A, 0x3F, 0x3E, 0x3B, 0x3E, 0x29, 0x29, 0x2A, 0x2A, 0x2E, 0x2A, 0x19, 0x09, 0x06, 0x12, 0x2B, 0x2F, 0x1B, 0x1A, 0x1A, 0x15, 0x01, 0x00, 0x11, 0x02, 0x02, 0x02, 0x01, 0x01, 0x11, 0x01, 0x01, 0x01, 0x01, 0x11, 0x24, 0x14, 0x20, 0x24, 0x14, 0x15, 0x05, 0x0A, 0x0B, 0x0B, 0x09, 0x09, 0x09, 0x09, 0x0A, 0x1D, 0x3A, 0x3F, 0x3E, 0x3A, 0x29, 0x04, 0x04, 0x05, 0x04},
    {0x3F, 0x3F, 0x3F, 0x3E, 0x3A, 0x3E, 0x3F, 0x3E, 0x3A, 0x29, 0x29, 0x2A, 0x2E, 0x29, 0x2E, 0x09, 0x09, 0x2F, 0x2A, 0x2F, 0x2B, 0x2B, 0x1B, 0x16, 0x15, 0x05, 0x15, 0x01, 0x01, 0x02, 0x02, 0x11, 0x01, 0x01, 0x02, 0x01, 0x02, 0x02, 0x01, 0x12, 0x24, 0x14, 0x24, 0x14, 0x14, 0x14, 0x09, 0x1A, 0x0A, 0x1A, 0x1E, 0x19, 0x0D, 0x0A, 0x1E, 0x3F, 0x3E, 0x3F, 0x3E, 0x18, 0x05, 0x04, 0x04, 0x14},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3A, 0x3E, 0x3A, 0x3A, 0x28, 0x15, 0x3A, 0x29, 0x3A, 0x2A, 0x09, 0x08, 0x0A, 0x2E, 0x2F, 0x3F, 0x3E, 0x2B, 0x2B, 0x1B, 0x0A, 0x15, 0x01, 0x02, 0x02, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x02, 0x02, 0x15, 0x20, 0x24, 0x24, 0x24, 0x15, 0x15, 0x0A, 0x0A, 0x0B, 0x1A, 0x0E, 0x09, 0x0A, 0x1E, 0x2A, 0x3E, 0x3F, 0x29, 0x04, 0x04, 0x04, 0x14, 0x18},
    {0x3F, 0x3F, 0x3F, 0x3E, 0x39, 0x29, 0x39, 0x29, 0x29, 0x18, 0x2A, 0x2D, 0x19, 0x19, 0x09, 0x08, 0x09, 0x2E, 0x2F, 0x2F, 0x2F, 0x17, 0x06, 0x17, 0x07, 0x16, 0x02, 0x02, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x16, 0x14, 0x20, 0x14, 0x24, 0x14, 0x19, 0x19, 0x0B, 0x05, 0x0A, 0x0E, 0x0A, 0x0E, 0x0A, 0x1E, 0x1A, 0x19, 0x18, 0x05, 0x04, 0x04, 0x28},
    {0x3F, 0x3E, 0x3F, 0x3A, 0x38, 0x28, 0x28, 0x29, 0x28, 0x19, 0x19, 0x19, 0x19, 0x29, 0x08, 0x04, 0x09, 0x1E, 0x2F, 0x2F, 0x2E, 0x1B, 0x03, 0x03, 0x03, 0x03, 0x02, 0x03, 0x12, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x12, 0x24, 0x24, 0x24, 0x24, 0x14, 0x29, 0x0A, 0x0A, 0x06, 0x1E, 0x09, 0x0E, 0x0A, 0x0E, 0x0A, 0x09, 0x08, 0x09, 0x04, 0x04, 0x18},
    {0x29, 0x39, 0x28, 0x14, 0x18, 0x28, 0x14, 0x14, 0x18, 0x14, 0x19, 0x19, 0x19, 0x04, 0x08, 0x09, 0x0A, 0x1E, 0x2F, 0x3F, 0x2F, 0x2F, 0x0B, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x02, 0x03, 0x02, 0x02, 0x02, 0x02, 0x01, 0x14, 0x10, 0x24, 0x24, 0x28, 0x19, 0x0A, 0x05, 0x0A, 0x0A, 0x09, 0x0A, 0x09, 0x09, 0x09, 0x0A, 0x04, 0x09, 0x04, 0x14},
    {0x04, 0x04, 0x14, 0x08, 0x05, 0x09, 0x04, 0x04, 0x18, 0x04, 0x08, 0x15, 0x18, 0x04, 0x09, 0x09, 0x0A, 0x1F, 0x2F, 0x2F, 0x2F, 0x2F, 0x1F, 0x17, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x02, 0x03, 0x02, 0x03, 0x12, 0x02, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x11, 0x14, 0x24, 0x14, 0x24, 0x28, 0x15, 0x0A, 0x09, 0x0A, 0x0D, 0x09, 0x08, 0x09, 0x09, 0x09, 0x09, 0x04, 0x08, 0x08},
    {0x04, 0x04, 0x04, 0x09, 0x09, 0x08, 0x04, 0x04, 0x04, 0x05, 0x04, 0x08, 0x05, 0x08, 0x09, 0x09, 0x0E, 0x1F, 0x2F, 0x3F, 0x2F, 0x3F, 0x2F, 0x1E, 0x15, 0x15, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x13, 0x02, 0x03, 0x03, 0x03, 0x02, 0x02, 0x03, 0x03, 0x02, 0x02, 0x02, 0x01, 0x01, 0x15, 0x20, 0x14, 0x24, 0x25, 0x09, 0x05, 0x09, 0x09, 0x09, 0x09, 0x1A, 0x0A, 0x0E, 0x09, 0x09, 0x04, 0x08},
    {0x04, 0x04, 0x04, 0x09, 0x09, 0x09, 0x05, 0x04, 0x04, 0x04, 0x08, 0x08, 0x09, 0x09, 0x09, 0x0A, 0x09, 0x1E, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x1F, 0x19, 0x24, 0x02, 0x01, 0x12, 0x03, 0x03, 0x03, 0x03, 0x03, 0x02, 0x03, 0x03, 0x03, 0x02, 0x02, 0x03, 0x03, 0x02, 0x02, 0x01, 0x01, 0x16, 0x14, 0x10, 0x24, 0x24, 0x14, 0x15, 0x09, 0x09, 0x09, 0x1A, 0x2F, 0x3F, 0x1F, 0x09, 0x09, 0x08, 0x18},
    {0x04, 0x04, 0x04, 0x05, 0x0A, 0x0A, 0x08, 0x04, 0x08, 0x09, 0x08, 0x09, 0x0A, 0x0E, 0x0E, 0x0E, 0x0A, 0x0E, 0x2F, 0x2F, 0x2F, 0x2F, 0x2E, 0x0F, 0x19, 0x24, 0x12, 0x02, 0x01, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x02, 0x03, 0x02, 0x03, 0x02, 0x03, 0x03, 0x02, 0x02, 0x11, 0x01, 0x05, 0x15, 0x15, 0x14, 0x24, 0x14, 0x14, 0x14, 0x09, 0x09, 0x2F, 0x2F, 0x3F, 0x2F, 0x0E, 0x09, 0x08, 0x14},
    {0x09, 0x04, 0x04, 0x04, 0x0D, 0x0A, 0x09, 0x09, 0x09, 0x0D, 0x09, 0x0E, 0x0E, 0x0A, 0x0E, 0x0A, 0x0E, 0x09, 0x09, 0x1E, 0x1E, 0x1E, 0x0A, 0x1E, 0x0A, 0x29, 0x24, 0x02, 0x02, 0x01, 0x12, 0x03, 0x03, 0x03, 0x03, 0x02, 0x02, 0x03, 0x03, 0x02, 0x03, 0x03, 0x12, 0x02, 0x01, 0x01, 0x01, 0x14, 0x15, 0x21, 0x14, 0x20, 0x14, 0x10, 0x19, 0x09, 0x1F, 0x3F, 0x3F, 0x2F, 0x1E, 0x09, 0x05, 0x18},
    {0x09, 0x08, 0x09, 0x04, 0x0A, 0x0E, 0x1A, 0x0D, 0x0A, 0x0D, 0x0A, 0x0D, 0x0A, 0x0E, 0x0E, 0x0A, 0x09, 0x08, 0x09, 0x09, 0x09, 0x0A, 0x0E, 0x0A, 0x0A, 0x19, 0x28, 0x12, 0x02, 0x05, 0x01, 0x02, 0x03, 0x07, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x02, 0x01, 0x02, 0x05, 0x15, 0x14, 0x15, 0x10, 0x24, 0x14, 0x14, 0x10, 0x09, 0x19, 0x2F, 0x3F, 0x2F, 0x1A, 0x0A, 0x09, 0x28},
    {0x0A, 0x09, 0x09, 0x04, 0x0A, 0x0E, 0x0E, 0x0E, 0x0A, 0x0E, 0x09, 0x0E, 0x0A, 0x0A, 0x09, 0x09, 0x08, 0x09, 0x09, 0x0D, 0x09, 0x09, 0x0A, 0x09, 0x0D, 0x09, 0x29, 0x25, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x02, 0x03, 0x02, 0x03, 0x02, 0x03, 0x02, 0x02, 0x01, 0x02, 0x16, 0x11, 0x15, 0x24, 0x00, 0x15, 0x20, 0x14, 0x14, 0x14, 0x09, 0x0E, 0x2F, 0x1F, 0x0A, 0x09, 0x19, 0x19},
    {0x0A, 0x09, 0x09, 0x04, 0x0D, 0x1A, 0x1E, 0x0A, 0x09, 0x0D, 0x09, 0x09, 0x09, 0x09, 0x09, 0x08, 0x08, 0x08, 0x09, 0x0A, 0x0E, 0x09, 0x09, 0x09, 0x09, 0x09, 0x1E, 0x29, 0x15, 0x02, 0x12, 0x02, 0x03, 0x03, 0x12, 0x01, 0x02, 0x02, 0x02, 0x16, 0x02, 0x16, 0x02, 0x02, 0x02, 0x05, 0x01, 0x02, 0x05, 0x14, 0x10, 0x15, 0x14, 0x10, 0x14, 0x11, 0x09, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x05},
    {0x1E, 0x0A, 0x09, 0x08, 0x0A, 0x0A, 0x0E, 0x09, 0x08, 0x09, 0x09, 0x08, 0x08, 0x08, 0x08, 0x05, 0x04, 0x09, 0x09, 0x0D, 0x09, 0x09, 0x09, 0x09, 0x09, 0x1E, 0x2F, 0x2E, 0x29, 0x16, 0x02, 0x02, 0x02, 0x03, 0x03, 0x02, 0x05, 0x11, 0x16, 0x15, 0x15, 0x15, 0x02, 0x01, 0x02, 0x15, 0x11, 0x06, 0x15, 0x15, 0x29, 0x16, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x06, 0x15, 0x0A, 0x16, 0x16},
    {0x1E, 0x1A, 0x09, 0x09, 0x09, 0x09, 0x0A, 0x09, 0x04, 0x08, 0x04, 0x08, 0x05, 0x08, 0x04, 0x08, 0x04, 0x09, 0x0A, 0x0E, 0x09, 0x09, 0x09, 0x08, 0x1A, 0x2E, 0x2F, 0x2F, 0x3F, 0x15, 0x16, 0x02, 0x29, 0x15, 0x15, 0x15, 0x15, 0x15, 0x19, 0x15, 0x05, 0x16, 0x19, 0x16, 0x16, 0x1A, 0x1A, 0x1A, 0x2A, 0x1B, 0x1A, 0x1B, 0x1A, 0x1A, 0x16, 0x1A, 0x06, 0x1A, 0x1A, 0x16, 0x05, 0x16, 0x06, 0x1A},
    {0x1F, 0x0A, 0x0A, 0x09, 0x09, 0x08, 0x04, 0x04, 0x09, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x09, 0x0D, 0x0A, 0x09, 0x09, 0x09, 0x08, 0x05, 0x09, 0x2E, 0x2F, 0x3F, 0x3F, 0x3F, 0x29, 0x15, 0x16, 0x19, 0x16, 0x1A, 0x2A, 0x15, 0x15, 0x16, 0x1A, 0x1A, 0x1B, 0x1B, 0x1A, 0x1A, 0x1A, 0x1B, 0x1B, 0x1B, 0x2F, 0x1B, 0x1A, 0x1B, 0x1A, 0x1B, 0x0A, 0x16, 0x0B, 0x1A, 0x05, 0x06, 0x05, 0x16},
    {0x0E, 0x1E, 0x0A, 0x09, 0x04, 0x05, 0x09, 0x09, 0x08, 0x05, 0x08, 0x04, 0x04, 0x04, 0x04, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09, 0x04, 0x04, 0x04, 0x09, 0x1E, 0x2F, 0x3F, 0x2F, 0x3F, 0x2F, 0x2A, 0x15, 0x15, 0x1A, 0x16, 0x15, 0x16, 0x06, 0x1A, 0x1A, 0x1A, 0x2B, 0x2F, 0x1B, 0x1A, 0x16, 0x1A, 0x1A, 0x2B, 0x1E, 0x1B, 0x1B, 0x1B, 0x1B, 0x1A, 0x1B, 0x0A, 0x1B, 0x06, 0x15, 0x05, 0x16, 0x05},
    {0x0A, 0x0A, 0x09, 0x09, 0x04, 0x08, 0x09, 0x09, 0x0A, 0x09, 0x09, 0x04, 0x08, 0x04, 0x04, 0x04, 0x09, 0x09, 0x09, 0x08, 0x09, 0x08, 0x04, 0x05, 0x04, 0x19, 0x1E, 0x2F, 0x2A, 0x1B, 0x1A, 0x2A, 0x05, 0x15, 0x15, 0x1A, 0x1A, 0x1A, 0x16, 0x1A, 0x1B, 0x16, 0x1A, 0x1A, 0x1A, 0x2B, 0x15, 0x16, 0x1A, 0x1B, 0x1B, 0x2F, 0x1B, 0x1A, 0x1A, 0x1A, 0x06, 0x1A, 0x06, 0x1A, 0x16, 0x06, 0x1A, 0x1A},
    {0x0E, 0x09, 0x09, 0x04, 0x05, 0x09, 0x0A, 0x1E, 0x1E, 0x2F, 0x1E, 0x0A, 0x09, 0x04, 0x04, 0x04, 0x08, 0x04, 0x08, 0x09, 0x09, 0x04, 0x08, 0x04, 0x08, 0x09, 0x1E, 0x2F, 0x1B, 0x1F, 0x1B, 0x1A, 0x15, 0x15, 0x06, 0x16, 0x16, 0x0A, 0x16, 0x1A, 0x1B, 0x1A, 0x1B, 0x1B, 0x1B, 0x1B, 0x1A, 0x16, 0x1B, 0x1A, 0x1B, 0x1B, 0x1A, 0x1A, 0x06, 0x16, 0x06, 0x16, 0x06, 0x0A, 0x0A, 0x2E, 0x2B, 0x3F},
    {0x0A, 0x09, 0x05, 0x08, 0x04, 0x09, 0x0A, 0x1E, 0x2F, 0x2F, 0x1E, 0x1A, 0x0A, 0x08, 0x09, 0x04, 0x04, 0x18, 0x05, 0x09, 0x08, 0x05, 0x08, 0x04, 0x09, 0x0A, 0x1E, 0x1F, 0x2B, 0x1B, 0x1B, 0x1B, 0x16, 0x05, 0x16, 0x0A, 0x1A, 0x16, 0x1A, 0x1B, 0x1B, 0x1A, 0x17, 0x2A, 0x1A, 0x2B, 0x1B, 0x1A, 0x1A, 0x2B, 0x2A, 0x19, 0x16, 0x05, 0x01, 0x00, 0x05, 0x15, 0x00, 0x09, 0x09, 0x2B, 0x3E, 0x3F},
    {0x0E, 0x09, 0x08, 0x05, 0x08, 0x09, 0x1E, 0x1F, 0x2F, 0x2F, 0x2F, 0x1F, 0x1E, 0x09, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x09, 0x08, 0x05, 0x08, 0x0A, 0x0E, 0x0A, 0x1E, 0x1B, 0x2E, 0x1F, 0x2E, 0x1A, 0x1A, 0x2E, 0x2B, 0x15, 0x16, 0x05, 0x16, 0x15, 0x15, 0x15, 0x15, 0x1A, 0x15, 0x15, 0x16, 0x16, 0x2A, 0x25, 0x15, 0x01, 0x06, 0x00, 0x11, 0x00, 0x01, 0x05, 0x05, 0x09, 0x09, 0x2A, 0x3E},
    {0x0A, 0x09, 0x09, 0x09, 0x04, 0x09, 0x0A, 0x1E, 0x2F, 0x3F, 0x2F, 0x2E, 0x1E, 0x09, 0x08, 0x04, 0x08, 0x05, 0x04, 0x05, 0x08, 0x05, 0x08, 0x19, 0x09, 0x0A, 0x0A, 0x1E, 0x2E, 0x1E, 0x1A, 0x0E, 0x1E, 0x1A, 0x1E, 0x2F, 0x2A, 0x15, 0x15, 0x01, 0x01, 0x01, 0x01, 0x14, 0x25, 0x16, 0x16, 0x05, 0x16, 0x2A, 0x29, 0x25, 0x05, 0x02, 0x01, 0x04, 0x00, 0x01, 0x15, 0x05, 0x09, 0x09, 0x19, 0x1A},
    {0x09, 0x0D, 0x09, 0x09, 0x04, 0x09, 0x09, 0x09, 0x1A, 0x2F, 0x2F, 0x2F, 0x1E, 0x09, 0x09, 0x04, 0x04, 0x04, 0x04, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09, 0x0D, 0x09, 0x0A, 0x1A, 0x09, 0x09, 0x0A, 0x0E, 0x1E, 0x1E, 0x2E, 0x2E, 0x2E, 0x15, 0x06, 0x05, 0x06, 0x01, 0x01, 0x14, 0x39, 0x2A, 0x15, 0x16, 0x2A, 0x2A, 0x29, 0x15, 0x11, 0x06, 0x00, 0x11, 0x00, 0x01, 0x09, 0x09, 0x05, 0x08, 0x09},
    {0x09, 0x09, 0x09, 0x08, 0x04, 0x08, 0x05, 0x09, 0x09, 0x0E, 0x1E, 0x1E, 0x0A, 0x09, 0x09, 0x09, 0x08, 0x08, 0x18, 0x29, 0x19, 0x0E, 0x0A, 0x0A, 0x09, 0x09, 0x09, 0x09, 0x09, 0x05, 0x09, 0x09, 0x0A, 0x1A, 0x1E, 0x1E, 0x1A, 0x0E, 0x1A, 0x1A, 0x16, 0x02, 0x16, 0x01, 0x01, 0x24, 0x2A, 0x16, 0x1A, 0x1B, 0x3A, 0x29, 0x25, 0x15, 0x02, 0x01, 0x04, 0x01, 0x04, 0x05, 0x04, 0x09, 0x04, 0x04},
    {0x08, 0x04, 0x08, 0x04, 0x08, 0x04, 0x08, 0x04, 0x08, 0x05, 0x09, 0x0E, 0x0E, 0x0D, 0x0A, 0x09, 0x08, 0x28, 0x39, 0x2E, 0x3F, 0x2F, 0x1E, 0x0F, 0x0A, 0x09, 0x09, 0x09, 0x09, 0x04, 0x09, 0x09, 0x1E, 0x1E, 0x1F, 0x1A, 0x0E, 0x0A, 0x1E, 0x2F, 0x1A, 0x06, 0x05, 0x02, 0x05, 0x11, 0x29, 0x29, 0x17, 0x16, 0x2B, 0x3A, 0x25, 0x15, 0x02, 0x16, 0x19, 0x00, 0x11, 0x01, 0x09, 0x04, 0x05, 0x05},
    {0x04, 0x04, 0x04, 0x08, 0x05, 0x08, 0x04, 0x08, 0x04, 0x08, 0x09, 0x09, 0x09, 0x0E, 0x09, 0x09, 0x28, 0x39, 0x3D, 0x3E, 0x3F, 0x3F, 0x2F, 0x1E, 0x1F, 0x0A, 0x09, 0x09, 0x09, 0x0A, 0x1A, 0x1E, 0x2F, 0x2F, 0x1E, 0x1E, 0x0A, 0x1E, 0x2E, 0x1F, 0x1F, 0x1A, 0x16, 0x16, 0x01, 0x01, 0x01, 0x2A, 0x2A, 0x1A, 0x16, 0x2A, 0x2A, 0x25, 0x15, 0x02, 0x2E, 0x05, 0x01, 0x01, 0x04, 0x05, 0x08, 0x1A},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x09, 0x04, 0x04, 0x05, 0x04, 0x09, 0x09, 0x0D, 0x09, 0x09, 0x2C, 0x29, 0x3D, 0x3A, 0x3F, 0x3F, 0x3F, 0x2F, 0x2E, 0x0A, 0x09, 0x09, 0x09, 0x09, 0x1E, 0x2F, 0x1F, 0x2F, 0x2F, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x0A, 0x16, 0x06, 0x05, 0x00, 0x01, 0x2B, 0x2A, 0x16, 0x2A, 0x3A, 0x25, 0x15, 0x02, 0x19, 0x15, 0x00, 0x15, 0x05, 0x09, 0x1A, 0x2B},

}; // sequence of image

volatile uint16_t image_line = 0;

volatile uint8_t backPorchLinesToGo = VERTICAL_BACK_PORCH_LINES; // to count vertical porch

volatile uint16_t vLine = 0; // to count vertical position

void timer1_init(void) // timer1 : v sync
{
    TCCR1A = (1 << COM1B1) | (1 << COM1B0) | (1 << WGM11) | (1 << WGM10); // fast pwm mode 14, toggle for OC1B

    TCCR1B = (1 << WGM13) | (1 << WGM12) | (1 << CS12) | (1 << CS10); // prescaler 1024

    OCR1A = 259;

    OCR1B = 0;

    TIMSK = (1 << TOIE1); // timer1 overflow interrupt enable
}

void timer3_init(void) // timer3 : h sync
{

    TCCR3A = (1 << COM3A0) | (1 << COM3A1) | (1 << WGM31); // fast pwm mode 14, toggle for OC3A

    TCCR3B = (1 << WGM33) | (1 << WGM32) | (1 << CS31); // prescaler 8

    ICR3 = 63;

    OCR3A = 7;

    ETIMSK = (1 << TOIE3); // timer3 overflow interrupt enable
}

ISR(TIMER1_OVF_vect) // call for generate v sync
{
    vLine = 0;
    image_line = 0;
    backPorchLinesToGo = VERTICAL_BACK_PORCH_LINES;
    TCNT3 = 5; // value to synchronize v sync and h sync (adjustable)
}

ISR(TIMER3_OVF_vect) // call for generate h sync
{
}

void setup() // setup for timer, port, sleep mode
{

    cli();

    DDRB = 0xFF;
    DDRE = 0xFF;
    DDRC = 0xFF;

    MCUCR |= (1 << SE);

    timer1_init();
    timer3_init();

    sei();
}

void doOneScanLine(void)
{

    if (backPorchLinesToGo - 2)
    {
        PORTC = 0x00;
        backPorchLinesToGo--;
        return;
    }

    if (vLine >= 480 - 7 + 2)
    {
        PORTC = 0x00;
        vLine++;
        return;
    }

    __asm__ __volatile__(
        ".rept 30\n\t"
        "nop\n\t"
        ".endr\n\t");

    register uint8_t * pixel_Ptr = &(image_color[0][image_line]);

    __asm__ __volatile__(
        ".rept 16\n\t"
        "nop\n\t"
        ".endr\n\t");

    register uint8_t i = IMAGE_WIDTH;

    while(i--)
        PORTC = * pixel_Ptr++;

    // Back Porch delay before visible area
    nop;
    nop;
    nop;
    
    // Visible Area delay (25.4µs = 406 NOPs)


    PORTC = 0x00;
    vLine++;

    if(vLine % 10 == 0) {
        image_line++;
    } 
     
}


///////////////////////////////////////


void init_test_pattern(void) {
    for(uint8_t row = 0; row < IMAGE_HEIGHT; row++) {
        for(uint8_t col = 0; col < IMAGE_WIDTH; col++) {
            // Check if even or odd pixel position
            if((col + row) % 2 == 0) {
                image_color[col][row] = 0x3F;  // White (max brightness)
            } else {
                image_color[col][row] = 0x00;  // Black
            }
        }
    }
}



int main()
{
    setup();
    init_test_pattern();
    

    while (1)
    {
        sleep_mode();
        doOneScanLine();
    }

    return 0;
}
